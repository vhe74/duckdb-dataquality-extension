# name: test/sql/dq_test.test
# description: test dqtest extension
# group: [sql]

# Before we load the extension, this will fail
statement error
SELECT dqtest('Sam');
----
Catalog Error: Scalar Function with name dqtest does not exist!

# Require statement will ensure this test is run with this extension loaded
require dqtest

# Confirm the extension works
query I
SELECT dqtest('Sam');
----
Dqtest Sam üê•

# initialize dq
query I
call dq_init();
----
SUCCESS: DQ tables initialized

#create test tables
statement ok
CREATE TABLE customers (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    email VARCHAR,
    status VARCHAR,
    age INTEGER
);

statement ok
CREATE TABLE orders (
    order_id INTEGER PRIMARY KEY,
    customer_id INTEGER,
    amount DECIMAL(10,2),
    status VARCHAR
);

# Insert sample data
statement ok
INSERT INTO customers VALUES
    (1, 'Alice', 'alice@example.com', 'active', 25),
    (2, 'Bob', NULL, 'active', 30),
    (3, 'Charlie', 'charlie@example.com', 'inactive', 35);

statement ok
INSERT INTO orders VALUES
    (1, 1, 100.00, 'pending'),
    (2, 1, 200.00, 'shipped'),
    (3, 2, 150.00, 'delivered'),
    (4, 99, 50.00, 'pending');

# ============================================================================
# Test: Insert various test definitions
# ============================================================================

# Test 1: unique test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type)
VALUES ('customers_id_unique', 'customers', 'id', 'unique');

# Test 2: not_null test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type)
VALUES ('customers_email_not_null', 'customers', 'email', 'not_null');

# Test 3: accepted_values test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type, test_params)
VALUES ('customers_status_valid', 'customers', 'status', 'accepted_values',
        '{"values": ["active", "inactive", "suspended"]}');

# Test 4: regex test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type, test_params)
VALUES ('customers_email_format', 'customers', 'email', 'regex',
        '{"pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\\\.[a-zA-Z]{2,}$"}');

# Test 5: range test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type, test_params)
VALUES ('customers_age_range', 'customers', 'age', 'range',
        '{"min": 18, "max": 100}');

# Test 6: relationship test
statement ok
INSERT INTO dq_tests (test_name, table_name, column_name, test_type, test_params)
VALUES ('orders_customer_fk', 'orders', 'customer_id', 'relationship',
        '{"to_table": "customers", "to_column": "id"}');

# Test 7: row_count test
statement ok
INSERT INTO dq_tests (test_name, table_name, test_type, test_params)
VALUES ('customers_min_rows', 'customers', 'row_count',
        '{"min": 1, "max": 1000}');

# Test 8: custom_sql test
statement ok
INSERT INTO dq_tests (test_name, table_name, test_type, test_params)
VALUES ('orders_orphan_check', 'orders', 'custom_sql',
        '{"sql": "SELECT * FROM {table} WHERE customer_id NOT IN (SELECT id FROM customers)"}');

# Verify all tests were inserted
query I
SELECT COUNT(*) FROM dq_tests;
----
8

# Verify test types are correct
query I
SELECT COUNT(DISTINCT test_type) FROM dq_tests;
----
8

# Verify JSON params are stored correctly
query I
SELECT COUNT(*) FROM dq_tests WHERE test_params IS NOT NULL;
----
6